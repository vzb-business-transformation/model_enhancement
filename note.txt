Building stacked ensemble model...
Training stacked ensemble model...

Stacked Ensemble Performance:
MAE: 0.6519
MSE: 2.3836
RMSE: 1.5439
R2: 0.9192

Creating weighted voting ensemble...
Optimized weights: [0.165, 0.166, 0.168, 0.164, 0.167, 0.169]

Weighted Voting Ensemble Performance:
MAE: 0.6587
MSE: 2.5112
RMSE: 1.5847
R2: 0.9149

Evaluating all models...

rf model performance:
  MAE: 0.6464
  MSE: 3.0052
  RMSE: 1.7335
  R2: 0.8981

gb model performance:
  MAE: 0.7351
  MSE: 2.8048
  RMSE: 1.6748
  R2: 0.9049

xgb model performance:
  MAE: 0.6626
  MSE: 2.4799
  RMSE: 1.5748
  R2: 0.9159

lgb model performance:
  MAE: 0.8084
  MSE: 3.1610
  RMSE: 1.7779
  R2: 0.8928

cat model performance:
  MAE: 0.7260
  MSE: 2.6370
  RMSE: 1.6239
  R2: 0.9106

stacked_ensemble model performance:
  MAE: 0.6519
  MSE: 2.3836
  RMSE: 1.5439
  R2: 0.9192

voting_ensemble model performance:
  MAE: 0.6587
  MSE: 2.5112
  RMSE: 1.5847
  R2: 0.9149
Data processor saved to results/models/data_processor.joblib

Saving trained models...
Model 'rf' saved to results/models/rf_model.joblib
Model 'gb' saved to results/models/gb_model.joblib
Model 'xgb' saved to results/models/xgb_model.joblib
Model 'lgb' saved to results/models/lgb_model.joblib
Model 'cat' saved to results/models/cat_model.joblib
Model 'stacked_ensemble' saved to results/models/stacked_ensemble_model.joblib
Model 'voting_ensemble' saved to results/models/voting_ensemble_model.joblib
Feature importances saved to results/models/feature_importances.joblib
Model parameters saved to results/models/model_params.joblib

=== STEP 2: Predicting January 2025 data ===

Starting data preprocessing...
WARNING: Target column 'DISCO_DURATION' not found in initial dataframe
After distribution - Target column has 2407 non-NaN values out of 2407 rows
Engineering features...
Warning: Could not create distance buckets: Bin labels must be one fewer than the number of bin edges
Feature engineering complete. New shape: (2407, 96)
After feature engineering - Target column NaN count: 0
Before one-hot encoding - Target column exists: True
  Target column type: int64
  Target column non-NaN values: 2407
Categorical columns to encode: ['DOM_INTL_FLAG', 'INT_EXT_FLAG', 'REV_TYPE_FLAG', 'COST_TYPE_FLAG', 'FIRST_ADDR_TYPE_CODE', 'FIRST_ONNET', 'FIRST_INREGION', 'FIRST_XOLIT', 'ONNET_PROV', 'COMPANY_CODE', 'VRD_FLAG', 'OPCO_REV', 'IN_FOOTPRINT', 'NASP_TYPE', 'CIR_TECH_TYPE', 'CIR_BILL_TYPE', 'PROGRAM', 'BIZ_CASE', 'IEN_PROV', 'DISTANCE_BUCKET', 'RPTG_CIR_SPEED_TIER', 'ACCESS_SPEED_TIER', 'PORT_SPEED_TIER', 'PVC_CAR_SPEED_TIER', 'SPEED_TIER', 'TECH_BILL_COMBO']
After one-hot encoding - Target column exists: True
  Target column non-NaN values: 2407
Preprocessing complete. Final shape: (2407, 120)
After distribution - Target column NaN count: 0
Final preprocessed data - Target column exists: True
  Target column non-NaN values: 2407 out of 2407 rows
Error predicting with model rf: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- ACCESS_DISC
- ACCESS_DISC_RATE
- ACCESS_SPEED_SQUARED
- ACCESS_SPEED_TIER_High
- ACCESS_SPEED_TIER_Low
- ...

Error predicting with model gb: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- ACCESS_DISC
- ACCESS_DISC_RATE
- ACCESS_SPEED_SQUARED
- ACCESS_SPEED_TIER_High
- ACCESS_SPEED_TIER_Low
- ...

Error predicting with model xgb: feature_names mismatch: ['LVL_4_PRD_NM', 'VRTCL_MRKT_NAME', 'SALES_TIER', 'SR_CRCTP', 'RPTG_CRCTP', 'RPTG_CIR_SPEED', 'ACCESS_SPEED', 'PORT_SPEED', 'PVC_CAR_SPEED', 'MARGIN', 'FIRST_LAT', 'FIRST_LGNTD', 'PROD_YR_MTH', 'MONTH', 'VENDOR_COUNT', 'MONTH_SIN', 'MONTH_COS', 'CIRCUIT_AGE_DAYS', 'INST_MONTH', 'INST_DAY_OF_WEEK', 'ENDPOINT_DISTANCE_KM', 'SPEED_RATIO', 'SPEED_VARIATION', 'MAX_SPEED', 'TECH_ONNET_COMBO', 'MARKET_TIER_COMBO', 'MARGIN_SQUARED', 'LOG_MARGIN', 'LOG_ACCESS_SPEED', 'LOG_PORT_SPEED', 'REV_TYPE_FLAG_C ', 'COST_TYPE_FLAG_C ', 'COST_TYPE_FLAG_S ', 'COST_TYPE_FLAG_U ', 'FIRST_ADDR_TYPE_CODE_A', 'FIRST_ADDR_TYPE_CODE_SITE', 'FIRST_ONNET_Y ', 'FIRST_INREGION_OR', 'FIRST_XOLIT_Y ', 'COMPANY_CODE_XO', 'IN_FOOTPRINT_N ', 'IN_FOOTPRINT_Y ', 'CIR_TECH_TYPE_TDM', 'PROGRAM_NO ACTION', 'ACCESS_SPEED_TIER_Medium', 'PORT_SPEED_TIER_Medium'] ['LVL_4_PRD_NM', 'VRTCL_MRKT_NAME', 'SALES_TIER', 'SR_CRCTP', 'RPTG_CRCTP', 'RPTG_CIR_SPEED', 'ACCESS_SPEED', 'PORT_SPEED', 'PVC_CAR_SPEED', 'ACCESS_DISC', 'PORT_DISC', 'PVC_CAR_DISC', 'OTHER_DISC', 'OTHER_ADJ', 'MARGIN', 'FIRST_LAT', 'FIRST_LGNTD', 'PROD_YR_MTH', 'MONTH', 'YEAR', 'IS_QUARTER_END', 'IS_YEAR_END', 'VENDOR_COUNT', 'MONTH_SIN', 'MONTH_COS', 'CIRCUIT_AGE_DAYS', 'INST_MONTH', 'INST_QUARTER', 'INST_DAY_OF_WEEK', 'ENDPOINT_DISTANCE_KM', 'SPEED_RATIO', 'SPEED_VARIATION', 'MAX_SPEED', 'TOTAL_DISC', 'HAS_MULTIPLE_DISC', 'ACCESS_DISC_RATE', 'PORT_DISC_RATE', 'DISCONNECT_COMPLEXITY', 'MARGIN_SPEED_INTERACTION', 'MARGIN_DISCONNECT_RATIO', 'TECH_ONNET_COMBO', 'MARKET_TIER_COMBO', 'MARGIN_SQUARED', 'LOG_MARGIN', 'ACCESS_SPEED_SQUARED', 'LOG_ACCESS_SPEED', 'PORT_SPEED_SQUARED', 'LOG_PORT_SPEED', 'TOTAL_DISC_SQUARED', 'LOG_TOTAL_DISC', 'DOM_INTL_FLAG_I ', 'INT_EXT_FLAG_I ', 'REV_TYPE_FLAG_C ', 'REV_TYPE_FLAG_P ', 'COST_TYPE_FLAG_C ', 'COST_TYPE_FLAG_S ', 'COST_TYPE_FLAG_U ', 'FIRST_ADDR_TYPE_CODE_    ', 'FIRST_ADDR_TYPE_CODE_1', 'FIRST_ADDR_TYPE_CODE_2', 'FIRST_ADDR_TYPE_CODE_A', 'FIRST_ADDR_TYPE_CODE_O', 'FIRST_ADDR_TYPE_CODE_SERV', 'FIRST_ADDR_TYPE_CODE_SITE', 'FIRST_ADDR_TYPE_CODE_T', 'FIRST_ADDR_TYPE_CODE_Z', 'FIRST_ONNET_Y ', 'FIRST_INREGION_OR', 'FIRST_XOLIT_Y ', 'ONNET_PROV_Y ', 'COMPANY_CODE_VZT', 'COMPANY_CODE_XO', 'VRD_FLAG_M ', 'VRD_FLAG_V ', 'OPCO_REV_CANADA', 'OPCO_REV_EMEA', 'OPCO_REV_USOPS', 'IN_FOOTPRINT_N ', 'IN_FOOTPRINT_Y ', 'NASP_TYPE_INTERNAL', 'CIR_TECH_TYPE_ETHERNET', 'CIR_TECH_TYPE_OCN', 'CIR_TECH_TYPE_OTHER', 'CIR_TECH_TYPE_TDM', 'CIR_BILL_TYPE_INTERNAL', 'PROGRAM_CARRIER MGT', 'PROGRAM_NO ACTION', 'PROGRAM_NO ACTION -- ONNET', 'PROGRAM_NO ACTION -- VOICE', 'PROGRAM_NO REVENUE', 'PROGRAM_TDM TO ETHERNET', 'DISTANCE_BUCKET_Close', 'DISTANCE_BUCKET_Medium', 'DISTANCE_BUCKET_Far', 'DISTANCE_BUCKET_Very_Far', 'RPTG_CIR_SPEED_TIER_Low', 'RPTG_CIR_SPEED_TIER_Medium', 'RPTG_CIR_SPEED_TIER_High', 'RPTG_CIR_SPEED_TIER_Very High', 'ACCESS_SPEED_TIER_Low', 'ACCESS_SPEED_TIER_Medium', 'ACCESS_SPEED_TIER_High', 'ACCESS_SPEED_TIER_Very High', 'PORT_SPEED_TIER_Low', 'PORT_SPEED_TIER_Medium', 'PORT_SPEED_TIER_High', 'PORT_SPEED_TIER_Very High', 'PVC_CAR_SPEED_TIER_Low', 'PVC_CAR_SPEED_TIER_Medium', 'SPEED_TIER_Medium', 'SPEED_TIER_High', 'SPEED_TIER_Ultra', 'TECH_BILL_COMBO_EOTDM_INTERNAL', 'TECH_BILL_COMBO_ETHERNET_EXTERNAL', 'TECH_BILL_COMBO_OCN_EXTERNAL', 'TECH_BILL_COMBO_OTHER_EXTERNAL', 'TECH_BILL_COMBO_OTHER_INTERNAL', 'TECH_BILL_COMBO_TDM_EXTERNAL', 'TECH_BILL_COMBO_TDM_INTERNAL']
training data did not have the following fields: PORT_SPEED_TIER_High, RPTG_CIR_SPEED_TIER_High, SPEED_TIER_High, CIR_TECH_TYPE_ETHERNET, PROGRAM_NO ACTION -- ONNET, DISTANCE_BUCKET_Very_Far, DISTANCE_BUCKET_Medium, DISTANCE_BUCKET_Far, ONNET_PROV_Y , TOTAL_DISC, SPEED_TIER_Medium, TECH_BILL_COMBO_OCN_EXTERNAL, PROGRAM_NO REVENUE, ACCESS_DISC, DISCONNECT_COMPLEXITY, NASP_TYPE_INTERNAL, OPCO_REV_CANADA, ACCESS_SPEED_TIER_Low, VRD_FLAG_M , FIRST_ADDR_TYPE_CODE_2, TOTAL_DISC_SQUARED, IS_QUARTER_END, FIRST_ADDR_TYPE_CODE_SERV, RPTG_CIR_SPEED_TIER_Medium, FIRST_ADDR_TYPE_CODE_T, HAS_MULTIPLE_DISC, MARGIN_DISCONNECT_RATIO, ACCESS_SPEED_TIER_High, PORT_DISC_RATE, OTHER_DISC, LOG_TOTAL_DISC, TECH_BILL_COMBO_ETHERNET_EXTERNAL, OTHER_ADJ, IS_YEAR_END, PVC_CAR_SPEED_TIER_Low, FIRST_ADDR_TYPE_CODE_Z, TECH_BILL_COMBO_OTHER_EXTERNAL, SPEED_TIER_Ultra, PVC_CAR_SPEED_TIER_Medium, REV_TYPE_FLAG_P , RPTG_CIR_SPEED_TIER_Low, COMPANY_CODE_VZT, ACCESS_DISC_RATE, CIR_TECH_TYPE_OCN, TECH_BILL_COMBO_TDM_INTERNAL, FIRST_ADDR_TYPE_CODE_    , CIR_TECH_TYPE_OTHER, ACCESS_SPEED_SQUARED, DOM_INTL_FLAG_I , INT_EXT_FLAG_I , FIRST_ADDR_TYPE_CODE_1, PORT_DISC, VRD_FLAG_V , PROGRAM_NO ACTION -- VOICE, CIR_BILL_TYPE_INTERNAL, ACCESS_SPEED_TIER_Very High, PORT_SPEED_SQUARED, PORT_SPEED_TIER_Very High, INST_QUARTER, FIRST_ADDR_TYPE_CODE_O, TECH_BILL_COMBO_EOTDM_INTERNAL, YEAR, OPCO_REV_USOPS, DISTANCE_BUCKET_Close, TECH_BILL_COMBO_TDM_EXTERNAL, TECH_BILL_COMBO_OTHER_INTERNAL, RPTG_CIR_SPEED_TIER_Very High, PROGRAM_TDM TO ETHERNET, MARGIN_SPEED_INTERACTION, PROGRAM_CARRIER MGT, PORT_SPEED_TIER_Low, PVC_CAR_DISC, OPCO_REV_EMEA
Error predicting with model lgb: Number of features of the model must match the input. Model n_features_ is 46 and input n_features is 119
Error predicting with model stacked_ensemble: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- ACCESS_DISC
- ACCESS_DISC_RATE
- ACCESS_SPEED_SQUARED
- ACCESS_SPEED_TIER_High
- ACCESS_SPEED_TIER_Low
- ...

Error predicting with model voting_ensemble: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- ACCESS_DISC
- ACCESS_DISC_RATE
- ACCESS_SPEED_SQUARED
- ACCESS_SPEED_TIER_High
- ACCESS_SPEED_TIER_Low
- ...

January prediction metrics:
  MAE: 169.2747
  RMSE: 301.1494
  RÂ²: -0.4152
January predictions saved to results/january/january_predictions.csv

=== STEP 3: Enhancing model with January feedback ===

Traceback (most recent call last):
  File "/Users/SRIWOPE/miniforge3/envs/streamlit/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/Users/SRIWOPE/miniforge3/envs/streamlit/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/SRIWOPE/PycharmProjects/model_enhancement/enhance_predict_sequence.py", line 314, in <module>
    main()
  File "/Users/SRIWOPE/PycharmProjects/model_enhancement/enhance_predict_sequence.py", line 245, in main
    jan_predictions=jan_results_df[['CIR_ID', 'prediction_ensemble']].rename(
  File "/Users/SRIWOPE/miniforge3/envs/streamlit/lib/python3.9/site-packages/pandas/core/frame.py", line 4108, in __getitem__
    indexer = self.columns._get_indexer_strict(key, "columns")[1]
  File "/Users/SRIWOPE/miniforge3/envs/streamlit/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 6200, in _get_indexer_strict
    self._raise_if_missing(keyarr, indexer, axis_name)
  File "/Users/SRIWOPE/miniforge3/envs/streamlit/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 6252, in _raise_if_missing
    raise KeyError(f"{not_found} not in index")
KeyError: "['prediction_ensemble'] not in index"
(streamlit) SRIWOPE@XHK9JJM27Y model_enhancement %
